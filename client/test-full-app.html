<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full App Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        .success {
            background: #0a300a;
            border-color: #0f0;
        }
        .error {
            background: #300a0a;
            border-color: #f00;
        }
        .pending {
            background: #30300a;
            border-color: #ff0;
        }
    </style>
</head>
<body>
    <h1>Full Application Test</h1>
    <div id="tests"></div>

    <script type="module">
        const tests = [];
        const testsDiv = document.getElementById('tests');

        async function addTest(name, testFn) {
            const testDiv = document.createElement('div');
            testDiv.className = 'test-item pending';
            testDiv.innerHTML = `<strong>${name}:</strong> Testing...`;
            testsDiv.appendChild(testDiv);

            try {
                const result = await testFn();
                testDiv.className = 'test-item success';
                testDiv.innerHTML = `<strong>‚úì ${name}:</strong> ${result}`;
            } catch (error) {
                testDiv.className = 'test-item error';
                testDiv.innerHTML = `<strong>‚úó ${name}:</strong> ${error.message}`;
                console.error(`Test "${name}" failed:`, error);
            }
        }

        // Test 1: Three.js loading
        await addTest('Three.js Module', async () => {
            const THREE = await import('/node_modules/three/build/three.module.js');
            return `Loaded Three.js version ${THREE.REVISION}`;
        });

        // Test 2: TrajectoryService
        await addTest('TrajectoryService', async () => {
            const { TrajectoryService } = await import('/src/services/TrajectoryService.js');
            const service = new TrajectoryService();
            return 'TrajectoryService loaded successfully';
        });

        // Test 3: Backend Health Check
        await addTest('Backend Health', async () => {
            const response = await fetch('http://localhost:3010/health');
            const data = await response.json();
            if (data.status === 'healthy') {
                return `Backend is ${data.status} on port ${data.port}`;
            }
            throw new Error('Backend unhealthy');
        });

        // Test 4: SimulationConfig
        await addTest('SimulationConfig', async () => {
            const { SimulationConfig } = await import('/src/config/SimulationConfig.js');
            return `Config loaded - Backend URL: ${SimulationConfig.dataSource.backendUrl}`;
        });

        // Test 5: SimulationManager
        await addTest('SimulationManager', async () => {
            const { SimulationManager } = await import('/src/simulation/SimulationManager.js');
            return 'SimulationManager loaded successfully';
        });

        // Test 6: SceneManager
        await addTest('SceneManager', async () => {
            const { SceneManager } = await import('/src/core/SceneManager.js');
            return 'SceneManager loaded successfully';
        });

        // Test 7: CameraController
        await addTest('CameraController', async () => {
            const { CameraController } = await import('/src/core/CameraController.js');
            return 'CameraController loaded successfully';
        });

        // Test 8: Mars Environment
        await addTest('Mars Component', async () => {
            const { Mars } = await import('/src/components/environment/Mars.js');
            return 'Mars component loaded successfully';
        });

        // Test 9: Entry Vehicle
        await addTest('EntryVehicle', async () => {
            const { EntryVehicle } = await import('/src/components/spacecraft/EntryVehicle.js');
            return 'EntryVehicle component loaded successfully';
        });

        // Test 10: Backend Trajectory Calculation
        await addTest('Backend Trajectory API', async () => {
            const response = await fetch('http://localhost:3010/high-fidelity/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    control: { bank_angle: 0.0 },
                    serialize_arrow: false
                })
            });
            const data = await response.json();
            if (data.time_s && data.x_m) {
                return `Received ${data.time_s.length} trajectory points from backend`;
            }
            throw new Error('Invalid trajectory response');
        });

        // Summary
        const allSuccess = testsDiv.querySelectorAll('.success').length;
        const allError = testsDiv.querySelectorAll('.error').length;

        const summaryDiv = document.createElement('div');
        summaryDiv.style.marginTop = '20px';
        summaryDiv.style.padding = '15px';
        summaryDiv.style.border = '2px solid ' + (allError === 0 ? '#0f0' : '#f00');
        summaryDiv.style.borderRadius = '5px';
        summaryDiv.innerHTML = `
            <h2>Test Summary</h2>
            <p>‚úì Passed: ${allSuccess}</p>
            <p>‚úó Failed: ${allError}</p>
            <p style="font-size: 20px; font-weight: bold;">
                ${allError === 0 ? 'üéâ All tests passed! The application should work correctly.' : '‚ö†Ô∏è Some tests failed. Please check the errors above.'}
            </p>
        `;
        testsDiv.appendChild(summaryDiv);
    </script>
</body>
</html>