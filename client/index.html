<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Experience the HSV Entry, Descent, and Landing simulation with real trajectory data and interactive 3D visualization">
    <meta name="keywords" content="HSV, EDL, NASA, simulation, 3D, Three.js, space, landing">
    <meta name="author" content="Hypersonic Vehicle Simulation Team">

    <title>HSV Pre-Landing Simulation</title>

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="HSV Pre-Landing Simulation">
    <meta property="og:description" content="Experience the 7 Minutes of Terror - HSV Entry, Descent & Landing">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/assets/images/hsv-preview.jpg">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/images/wpi-logo.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles/app.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading HSV EDL Simulation...</div>
            <div class="loading-progress">
                <div class="loading-bar" id="loading-bar"></div>
            </div>
            <div id="loading-status" style="font-size: 12px; color: #666; margin-top: 10px;">
                Initializing...
            </div>
        </div>
    </div>

    <!-- Main Canvas Container -->
    <div id="canvas-container" role="application" aria-label="HSV EDL 3D Simulation"></div>

    <!-- Header -->
    <header class="header">
        <div class="mission-info">
            <div class="wpi-logo" aria-label="WPI Logo">
                <img src="/assets/images/wpi-logo.png" alt="WPI Logo">
            </div>
            <div class="mission-title">
                <strong>HSV Simulation</strong>
                <span>Entry Descent Landing</span>
            </div>
        </div>
        <div class="simulation-badge">PRE-LANDING SIMULATION</div>
    </header>

    <!-- Phase Information Panel -->
    <div id="phase-info" role="region" aria-label="Mission Phase Information"></div>

    <!-- Timeline Controls -->
    <div id="timeline-container" role="region" aria-label="Simulation Timeline Controls"></div>
    
    <!-- Zoom Controls -->
    <div class="zoom-controls" role="group" aria-label="Zoom Controls">
        <button class="zoom-btn zoom-in" aria-label="Zoom In" title="Zoom In">+</button>
        <button class="zoom-btn zoom-reset" aria-label="Reset Zoom" title="Reset Zoom">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
        </button>
        <button class="zoom-btn zoom-out" aria-label="Zoom Out" title="Zoom Out">âˆ’</button>
    </div>

    <!-- Screen Reader Announcements -->
    <div class="sr-only" role="status" aria-live="polite" aria-atomic="true" id="sr-announcements"></div>

    <!-- No WebGL Support Message -->
    <noscript>
        <div class="no-webgl">
            <h2>JavaScript Required</h2>
            <p>This simulation requires JavaScript to be enabled in your browser.</p>
            <p>Please enable JavaScript and refresh the page to continue.</p>
        </div>
    </noscript>

    <!-- Three.js -->
    <!-- Import map for Three.js module resolution -->
    <script type="importmap">
    {
        "imports": {
            "three": "/node_modules/three/build/three.module.js",
            "three/": "/node_modules/three/"
        }
    }
    </script>

    <!-- Main Application -->
    <script type="module">
        // Loading simulation
        const loadingBar = document.getElementById('loading-bar');
        const loadingStatus = document.getElementById('loading-status');
        
        // Simulate loading progress
        const updateLoading = (progress, status) => {
            loadingBar.style.width = `${progress}%`;
            loadingStatus.textContent = status;
        };
        
        // Add the missing hideLoadingScreen function
        function hideLoadingScreen() {
            const loader = document.getElementById('loading-screen');
            if (loader) {
                loader.style.transition = 'opacity 0.5s';
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }
        }
        
        // Loading stages
        setTimeout(() => updateLoading(20, 'Loading Three.js...'), 100);
        setTimeout(() => updateLoading(40, 'Creating scene...'), 500);
        setTimeout(() => updateLoading(60, 'Loading trajectory data...'), 1000);
        setTimeout(() => updateLoading(80, 'Initializing controls...'), 1500);
        setTimeout(() => updateLoading(100, 'Ready!'), 2000);
        
        // Define zoom control initialization function
        window.initializeZoomControls = function() {
            const zoomInBtn = document.querySelector('.zoom-in');
            const zoomOutBtn = document.querySelector('.zoom-out');
            const zoomResetBtn = document.querySelector('.zoom-reset');

            if (window.MarsEDL && window.MarsEDL.simulation) {
                const cameraController = window.MarsEDL.simulation.cameraController;

                if (!cameraController) {
                    console.error('Camera controller not found');
                    return;
                }

                console.log('Setting up zoom controls, camera controller found:', cameraController);

                zoomInBtn?.addEventListener('click', () => {
                    console.log('Zoom in clicked');
                    if (cameraController.mode === 'orbit') {
                        cameraController.orbit.radius *= 0.8;
                        cameraController.orbit.radius = Math.max(
                            cameraController.state.minDistance,
                            cameraController.orbit.radius
                        );
                    } else {
                        cameraController.state.distance *= 0.8;
                        cameraController.state.distance = Math.max(
                            cameraController.state.minDistance,
                            cameraController.state.distance
                        );
                    }
                });

                zoomOutBtn?.addEventListener('click', () => {
                    console.log('Zoom out clicked');
                    if (cameraController.mode === 'orbit') {
                        cameraController.orbit.radius *= 1.25;
                        cameraController.orbit.radius = Math.min(
                            cameraController.state.maxDistance,
                            cameraController.orbit.radius
                        );
                    } else {
                        cameraController.state.distance *= 1.25;
                        cameraController.state.distance = Math.min(
                            cameraController.state.maxDistance,
                            cameraController.state.distance
                        );
                    }
                });

                zoomResetBtn?.addEventListener('click', () => {
                    console.log('Zoom reset clicked');
                    if (cameraController.mode === 'orbit') {
                        cameraController.orbit.radius = 100;
                    } else {
                        cameraController.state.distance = cameraController.state.defaultDistance;
                    }
                });

                // Make buttons visible
                if (zoomInBtn) zoomInBtn.style.display = 'flex';
                if (zoomOutBtn) zoomOutBtn.style.display = 'flex';
                if (zoomResetBtn) zoomResetBtn.style.display = 'flex';

                console.log('Zoom controls initialized successfully');
            } else {
                console.warn('MarsEDL simulation not yet ready for zoom controls');
                return false;
            }
            return true;
        };

        // Import main application
        import("./src/main.js").then((module) => {
            console.log('Main module loaded successfully:', module);
            // Main.js will handle hiding the loading screen
            
            // Add zoom control functionality
            setTimeout(() => {
                const zoomInBtn = document.querySelector('.zoom-in');
                const zoomOutBtn = document.querySelector('.zoom-out');
                const zoomResetBtn = document.querySelector('.zoom-reset');

                if (window.MarsEDL && window.MarsEDL.simulation) {
                    // Fix: cameraController is directly on simulation, not on scene
                    const cameraController = window.MarsEDL.simulation.cameraController;

                    if (!cameraController) {
                        console.error('Camera controller not found');
                        return;
                    }

                    console.log('Setting up zoom controls, camera controller found:', cameraController);

                    zoomInBtn?.addEventListener('click', () => {
                        console.log('Zoom in clicked');
                        if (cameraController.mode === 'orbit') {
                            cameraController.orbit.radius *= 0.8;
                            cameraController.orbit.radius = Math.max(
                                cameraController.state.minDistance,
                                cameraController.orbit.radius
                            );
                        } else {
                            cameraController.state.distance *= 0.8;
                            cameraController.state.distance = Math.max(
                                cameraController.state.minDistance,
                                cameraController.state.distance
                            );
                        }
                    });

                    zoomOutBtn?.addEventListener('click', () => {
                        console.log('Zoom out clicked');
                        if (cameraController.mode === 'orbit') {
                            cameraController.orbit.radius *= 1.25;
                            cameraController.orbit.radius = Math.min(
                                cameraController.state.maxDistance,
                                cameraController.orbit.radius
                            );
                        } else {
                            cameraController.state.distance *= 1.25;
                            cameraController.state.distance = Math.min(
                                cameraController.state.maxDistance,
                                cameraController.state.distance
                            );
                        }
                    });

                    zoomResetBtn?.addEventListener('click', () => {
                        console.log('Zoom reset clicked');
                        if (cameraController.mode === 'orbit') {
                            cameraController.orbit.radius = 100;
                        } else {
                            cameraController.state.distance = cameraController.state.defaultDistance;
                        }
                    });

                    // Make buttons visible
                    if (zoomInBtn) zoomInBtn.style.display = 'flex';
                    if (zoomOutBtn) zoomOutBtn.style.display = 'flex';
                    if (zoomResetBtn) zoomResetBtn.style.display = 'flex';
                } else {
                    console.error('MarsEDL simulation not found');
                }
            }, 3000); // Wait for simulation to initialize
        }).catch(error => {
            console.error('Failed to load application:', error);
            document.getElementById('loading-screen').innerHTML = `
                <div class="no-webgl">
                    <h2>Loading Error</h2>
                    <p>Failed to load the simulation. Please check your internet connection and refresh the page.</p>
                    <p style="font-size: 12px; color: #666;">Error: ${error.message}</p>
                    <button id="reload-button" style="margin-top: 20px; padding: 10px 20px; background: #ff6600; border: none; color: white; border-radius: 5px; cursor: pointer;">
                        Reload Page
                    </button>
                </div>
            `;
            // Add event listener for reload button (CSP safe)
            const reloadBtn = document.getElementById('reload-button');
            if (reloadBtn) {
                reloadBtn.addEventListener('click', () => {
                    window.location.reload();
                });
            }
        });
    </script>
<div id="ui-overlay"></div>
</body>
</html>